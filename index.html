<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>بازی سه مرحله‌ای</title>
  <style>
    body {
      background-color: #111827;
      color: #f3f4f6;
      font-family: Tahoma, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      direction: rtl;
      padding: 10px;
      touch-action: none;
    }

    h2 { font-size: 3rem; }

    /* Progress emojis */
    .emoji-progress {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    .emoji-box {
      width: 100px;
      height: 100px;
      font-size: 50px;
      background: #1f2937;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .emoji-box.revealed {
      background: #16a34a;
      color: #fff;
      animation: glow 1s ease infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 4px #22c55e; }
      to   { box-shadow: 0 0 10px #22c55e; }
    }

    /* Main container */
    .container {
      background: #1f2937;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      width: 80%;
      max-width: 48rem;
      text-align: center;
      margin: 3rem 0;
      min-height: 20rem;
      font-size: 2rem;
    }

    input, button {
      width: 80%;
      padding: 1rem;
      margin: 1rem 0;
      font-size: 2rem;
      border-radius: 8px;
    }

    input {
      border: 1px solid #374151;
      background: #1f2937;
      color: #f3f4f6;
    }
    button {
      background: #3b82f6;
      border: none;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #2563eb; }
    #skipBtn { background: #f59e0b; margin-top: 6px; }

    #error { color: #f87171; font-size: 13px; margin-top: 6px; }
    #success { color: #4ade80; font-size: 14px; margin-top: 6px; }

    /* Memory game */
    #memory-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      justify-content: center;
      margin-top: 10px;
    }
    .card {
      aspect-ratio: 1;
      background: #374151;
      border-radius: 6px;
      font-size: 4rem;
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card.flipped { background: #4b5563; color: #f9fafb; }
    .card.matched { background: #10b981; color: #f9fafb; }

    /* Word Puzzle */
    #word-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 20px;
    }
    .letter {
      background: #374151;
      padding: 14px 20px;
      border-radius: 8px;
      cursor: grab;
      font-size: 2.4rem;
      user-select: none;
    }
    .letter.dragging { opacity: 0.5; }
    .letter.selected { outline: 2px solid #facc15; }

    #wp-status { margin-top: 14px; font-size: 1.5rem; color: #9ca3af; }

    /* Congrats Page */
    #congrats h2 { color: #4ade80; }
    #congrats .emoji-progress { justify-content: center; }
  </style>
</head>
<body>

<!-- Welcome Page -->
<div class="container" id="welcome">
  <h2>راز ۳ مرحله‌ای</h2>
  <p style="font-size:2rem;color:#9ca3af;">میتونی راز ۳ مرحله ای رو پیدا کنی؟</p>
  <button onclick="startGame()">آره میتونم</button>
</div>

<!-- Emoji Progress -->
<div class="emoji-progress" id="progress" style="display:none;">
  <div class="emoji-box" id="box1">❓</div>
  <div class="emoji-box" id="box2">❓</div>
  <div class="emoji-box" id="box3">❓</div>
</div>

<!-- Phase 1 -->
<div class="container" id="phase1" style="display:none;">
  <h2>مرحله اول</h2>
  <div id="question"></div>
  <div id="blank-line" style="font-size: 40px; margin: 30px; letter-spacing: 3px;"></div>
  <input id="answerInput" />
  <button onclick="checkAnswer()">ارسال</button>
  <button id="hintBtn" onclick="showHint()">💡</button>
  <button id="skipBtn" onclick="skipPhase(1)">⏭ رد شدن</button>
  <div id="error"></div>
  <div id="success"></div>
</div>

<!-- Phase 2 -->
<div class="container" id="phase2" style="display:none;">
  <h2>مرحله دوم</h2>
  <p style="font-size:2rem;color:#9ca3af;">کارت‌های مشابه رو پیدا کن</p>
  <div id="memory-grid"></div>
  <button id="skipBtn" onclick="skipPhase(2)">⏭ رد شدن</button>
</div>

<!-- Phase 3 -->
<div class="container" id="phase3" style="display:none;">
  <h2>مرحله سوم</h2>
  <p style="font-size:2rem;color:#9ca3af;">حروف رو مرتب کن</p>
  <div id="word-row"></div>
  <div id="wp-status"></div>
  <button onclick="reshuffleWord()">🔀 درهم کن</button>
  <button id="skipBtn" onclick="skipPhase(3)">⏭ رد شدن</button>
</div>

<!-- Congrats Page -->
<div class="container" id="congrats" style="display:none;">
  <h2>🎉 آفرین!</h2>
  <div class="emoji-progress">
    <div class="emoji-box revealed">📿</div>
    <div class="emoji-box revealed">🎧</div>
    <div class="emoji-box revealed">✏️📓</div>
  </div>
  <p style="font-size:2rem;color:#9ca3af;">
    آفرین رمز ۳ مرحله‌ای رو پیدا کردی.<br>
    بنظرت معنی این رمز چیه؟
  </p>
</div>

<script>
  // ========= Navigation =========
  function startGame() {
    document.getElementById("welcome").style.display = "none";
    document.getElementById("progress").style.display = "flex";
    document.getElementById("phase1").style.display = "block";
  }

  function revealBox(n, emoji) {
    const box = document.getElementById(`box${n}`);
    box.innerText = emoji;
    box.classList.add("revealed");
  }

  function skipPhase(phase) {
    if (phase === 1) {
      document.getElementById("phase1").style.display = "none";
      revealBox(1,"📿");
      startMemoryGame();
    }
    if (phase === 2) {
      document.getElementById("phase2").style.display = "none";
      revealBox(2,"🎧");
      startWordPuzzle();
    }
    if (phase === 3) {
      revealBox(3,"✏️📓");
      document.getElementById("phase3").style.display="none";
      document.getElementById("congrats").style.display="block";
    }
  }

  // ========= Phase 1 =========
  const stages = [
    { question: "تو .... ترین آدمی هستی که توی عمرم دیدم.", answer: "آشنا" },
    { question: "تو نباید ناراحت باشی چون تو یک .... ......", answer: "خرس پشمالویی" },
    { question: "- ظاهرمم ترسناکه؟ +یکمم .....", answer: "خنگین" },
    { question: "اسمت تو گوشی من چی سیوه؟  .....ِ من.", answer: "مروارید" }
  ];
  let currentStage = 0;

  function renderBlankLines(word) {
    const blankDiv = document.getElementById("blank-line");
    blankDiv.innerHTML = word.split("").map(ch => (ch===" "?" ":"ــ")).join(" ");
  }

  function loadStage() {
    const q = stages[currentStage];
    document.getElementById("question").innerText = q.question;
    document.getElementById("answerInput").value = "";
    document.getElementById("error").innerText = "";
    document.getElementById("success").innerText = "";
    renderBlankLines(q.answer);
  }

  function checkAnswer() {
    const input = document.getElementById("answerInput").value.trim().toLowerCase();
    const correct = stages[currentStage].answer.toLowerCase();
    if (input === correct) {
      document.getElementById("success").innerText = "✅ درست بود";
      setTimeout(() => {
        currentStage++;
        if (currentStage < stages.length) loadStage();
        else skipPhase(1);
      }, 700);
    } else {
      document.getElementById("error").innerText = "❌ نه عزیزم، دوباره امتحان کن.";
    }
  }
  function showHint() {
    const answer = stages[currentStage].answer;
    document.getElementById("answerInput").value = answer[0] || "";
  }
  loadStage();

  // ========= Phase 2 (Memory) =========
  let flippedCards = [], matchedCount = 0;
  function startMemoryGame() {
    document.getElementById("phase2").style.display = "block";
    const emojiPairs = ['🍎','🐶','🚗','🍕','🌸','🐱','🎈','🧸','🌞','📚','🧃','🧦']; 
    const uniqueEmoji = '🎧';
    let allCards = [...emojiPairs, ...emojiPairs];
    allCards.push(uniqueEmoji);
    allCards = allCards.sort(()=>Math.random()-0.5);
    const grid = document.getElementById("memory-grid");
    grid.innerHTML="";
    flippedCards=[]; matchedCount=0;
    allCards.forEach(emoji=>{
      const card=document.createElement("div");
      card.className="card";
      card.dataset.emoji=emoji;
      card.onclick=()=>flipCard(card);
      grid.appendChild(card);
    });
  }
  function flipCard(card) {
    if (card.classList.contains("flipped")||card.classList.contains("matched")) return;
    card.classList.add("flipped");
    card.innerText=card.dataset.emoji;
    flippedCards.push(card);
    if (flippedCards.length===2) {
      const [f,s]=flippedCards;
      if (f.dataset.emoji===s.dataset.emoji) {
        f.classList.add("matched"); s.classList.add("matched");
        flippedCards=[]; matchedCount++;
        if (matchedCount===12) {
          setTimeout(()=>skipPhase(2),800);
        }
      } else {
        setTimeout(()=>{
          f.classList.remove("flipped"); s.classList.remove("flipped");
          f.innerText=""; s.innerText="";
          flippedCards=[];
        },700);
      }
    }
  }

  // ========= Phase 3 (Word Puzzle: Multiple Stages) =========
  const wpStages = [
    { word: "گلابی" },
    { word: "دابسمش" },
    { word: "سمساری" },
    { word: "خشوک" }
  ];
  let wpIndex = 0;
  let selectedEl = null;
  let idCounter = 0;

  const wordRow = document.getElementById("word-row");
  const statusEl = document.getElementById("wp-status");

  function startWordPuzzle() {
    document.getElementById("phase3").style.display = "block";
    wpIndex = 0;
    buildWordRow();
  }

  function reshuffleWord() {
    buildWordRow(true);
    statusEl.textContent = "🔀 دوباره درهم شد!";
    statusEl.style.color = "#9ca3af";
  }

  function buildWordRow(forceShuffle=false) {
    wordRow.innerHTML = "";
    selectedEl = null;
    const targetWord = wpStages[wpIndex].word;
    const chars = Array.from(targetWord);
    let scrambled = shuffle(chars.slice());
    if (!forceShuffle && scrambled.join("") === chars.join("")) {
      scrambled = shuffle(chars.slice());
      if (scrambled.join("") === chars.join("")) scrambled.reverse();
    }

    scrambled.forEach((ch, i) => {
      const tile = document.createElement("div");
      tile.className = "letter";
      tile.textContent = ch;
      tile.id = "letter-" + (idCounter++);
      tile.setAttribute("draggable", "true");

      // Drag & Drop
      tile.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", tile.id);
        setTimeout(()=> tile.classList.add("dragging"), 0);
      });
      tile.addEventListener("dragend", () => tile.classList.remove("dragging"));
      tile.addEventListener("dragover", (e) => e.preventDefault());
      tile.addEventListener("drop", (e) => {
        e.preventDefault();
        const fromId = e.dataTransfer.getData("text/plain");
        const fromEl = document.getElementById(fromId);
        if (fromEl && fromEl !== tile) {
          swapElements(fromEl, tile);
          checkSolved();
        }
      });

      // Tap-to-swap (mobile)
      tile.addEventListener("click", () => {
        if (!selectedEl) {
          selectedEl = tile;
          tile.classList.add("selected");
        } else if (selectedEl === tile) {
          tile.classList.remove("selected");
          selectedEl = null;
        } else {
          swapElements(selectedEl, tile);
          selectedEl.classList.remove("selected");
          selectedEl = null;
          checkSolved();
        }
      });

      wordRow.appendChild(tile);
    });

    statusEl.style.color = "#9ca3af";
    statusEl.textContent = `مرحله ${wpIndex+1} از ${wpStages.length} — حروف را درست کن`;
  }

  function swapElements(a, b) {
    const parent = a.parentNode;
    const aNext = a.nextSibling === b ? a : a.nextSibling;
    parent.insertBefore(a, b);
    parent.insertBefore(b, aNext);
  }

  function currentWordFromDOM() {
    return Array.from(wordRow.querySelectorAll(".letter"))
      .map(el => el.textContent)
      .join("");
  }

  function checkSolved() {
    const targetWord = wpStages[wpIndex].word;
    const now = currentWordFromDOM();
    if (now === targetWord) {
      statusEl.style.color = "#4ade80";
      statusEl.textContent = "✅ درست شد!";
      setTimeout(() => {
        wpIndex++;
        if (wpIndex < wpStages.length) {
          buildWordRow();
        } else {
          skipPhase(3);
        }
      }, 600);
    } else {
      statusEl.style.color = "#9ca3af";
      statusEl.textContent = "هنوز کامل نشده…";
    }
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
</script>

</body>
</html>

