<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>بازی سه مرحله‌ای</title>
  <style>
    body {
      background-color: #111827;
      color: #f3f4f6;
      font-family: Tahoma, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      direction: rtl;
      padding: 10px;
      touch-action: none; /* prevents browser scrolling during swipe */
    }

    .emoji-progress {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .emoji-box {
      width: 40px;
      height: 40px;
      font-size: 24px;
      background: #1f2937;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .emoji-box.revealed {
      background: #16a34a;
      color: #fff;
      animation: glow 1s ease infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 5px #22c55e; }
      to { box-shadow: 0 0 15px #22c55e; }
    }

    .container {
      background: #1f2937;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 480px;
      text-align: center;
      margin: 10px 0;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      border-radius: 8px;
    }

    input {
      border: 1px solid #374151;
      background-color: #1f2937;
      color: #f3f4f6;
    }

    input:focus { border-color: #3b82f6; }

    button {
      background-color: #3b82f6;
      border: none;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover { background-color: #2563eb; }

    #hintBtn {
      width: 50px;
      height: 50px;
      font-size: 24px;
      border-radius: 10px;
      padding: 0;
    }

    #error { color: #f87171; font-size: 14px; margin-top: 8px; }
    #success { color: #4ade80; font-size: 16px; font-weight: bold; margin-top: 10px; }

    #memory-grid {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .card {
      width: 60px;
      height: 60px;
      background: #374151;
      border-radius: 8px;
      font-size: 32px;
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }

    .card.flipped {
      background: #4b5563;
      color: #f9fafb;
    }

    .card.matched {
      background: #10b981;
      color: #f9fafb;
      cursor: default;
    }

    .card.unique {
      box-shadow: 0 0 10px 4px #facc15;
      background: #7c3aed;
    }

    /* Maze */
    #maze {
      display: grid;
      grid-template-columns: repeat(7, 40px);
      grid-template-rows: repeat(7, 40px);
      gap: 3px;
      justify-content: center;
      margin: 20px auto;
    }
    .maze-cell {
      width: 40px;
      height: 40px;
      background: #374151;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .wall { background: #111827; }
    .player { background: #2563eb; color: #fff; }
    .goal { background: #10b981; }
  </style>
</head>
<body>

<div class="emoji-progress">
  <div class="emoji-box" id="box1">❓</div>
  <div class="emoji-box" id="box2">❓</div>
  <div class="emoji-box" id="box3">❓</div>
</div>

<!-- PHASE 1 -->
<div class="container" id="phase1">
  <h1>جملات زیر رو کامل کن.</h1>
  <div id="question" style="margin-bottom: 10px;"></div>
  <div id="blank-line" style="font-size: 24px; margin-bottom: 15px; letter-spacing: 4px;"></div>
  <input id="answerInput" />
  <div class="btn-group">
    <button onclick="checkAnswer()">ارسال</button>
    <button id="hintBtn" onclick="showHint()">💡</button>
  </div>
  <div id="error"></div>
  <div id="success"></div>
</div>

<!-- PHASE 2 -->
<div class="container" id="phase2" style="display: none;">
  <h1>مرحله دوم: پیدا کردن جفت کارت‌ها</h1>
  <div id="memory-grid"></div>
</div>

<!-- PHASE 3 -->
<div class="container" id="phase3" style="display: none;">
  <h1>مرحله سوم: از ✏️ به 📓 برس!</h1>
  <p style="font-size:14px;color:#9ca3af;">با کشیدن انگشت (Swipe) حرکت کن</p>
  <div id="maze"></div>
</div>

<script>
  // ===================== PROGRESS BOXES =====================
  function revealBox(n, emoji) {
    const box = document.getElementById(`box${n}`);
    box.innerText = emoji;
    box.classList.add("revealed");
  }

  // ===================== PHASE 1 =====================
  const stages = [
    { question: "تو .... ترین آدمی هستی که توی عمرم دیدم.", answer: "آشنا" },
    { question: "تو نباید ناراحت باشی چون تو یک .... ......", answer: "خرس پشمالویی" },
    { question: "- ظاهرمم ترسناکه؟ +یکمم .....", answer: "خنگین" },
    { question: "اسمت تو گوشی من چی سیوه؟  .....ِ من.", answer: "مروارید" }
  ];

  let currentStage = 0;

  function renderBlankLines(word) {
    const blankDiv = document.getElementById('blank-line');
    blankDiv.innerHTML = word.split('').map(char => (char === ' ' ? ' ' : 'ــ')).join(' ');
  }

  function loadStage() {
    const q = stages[currentStage];
    document.getElementById('question').innerText = q.question;
    document.getElementById('answerInput').value = '';
    document.getElementById('error').innerText = '';
    document.getElementById('success').innerText = '';
    renderBlankLines(q.answer);
  }

  function checkAnswer() {
    const input = document.getElementById('answerInput').value.trim().toLowerCase();
    const correct = stages[currentStage].answer.toLowerCase();
    if (input === correct) {
      document.getElementById('success').innerText = "✅ درست بود دختری";
      setTimeout(() => {
        currentStage++;
        if (currentStage < stages.length) {
          loadStage();
        } else {
          document.getElementById('phase1').style.display = "none";
          revealBox(1, "📿");
          startMemoryGame();
        }
      }, 800);
    } else {
      document.getElementById('error').innerText = "❌ نه عزیزم، دوباره امتحان کن.";
    }
  }

  function showHint() {
    const answer = stages[currentStage].answer.trim();
    if (answer.length > 0) {
      document.getElementById('answerInput').value = answer[0];
    }
  }

  loadStage();

  // ===================== PHASE 2 =====================
  let flippedCards = [];
  let matchedCount = 0;

  function startMemoryGame() {
    document.getElementById('phase2').style.display = "block";
    const emojiPairs = ['🍎','🐶','🚗','🍕','🌸','🐱','🎈','🧸','🌞','📚','🧃','🧦']; 
    const uniqueEmoji = '🎧';

    let allCards = [...emojiPairs, ...emojiPairs];
    allCards.push(uniqueEmoji);

    allCards = allCards.sort(() => Math.random() - 0.5);

    const grid = document.getElementById('memory-grid');
    grid.innerHTML = "";
    flippedCards = [];
    matchedCount = 0;

    allCards.forEach((emoji) => {
      const card = document.createElement('div');
      card.className = "card";
      card.dataset.emoji = emoji;
      card.onclick = () => flipCard(card);
      grid.appendChild(card);
    });
  }

  function flipCard(card) {
    if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
    card.classList.add('flipped');
    card.innerText = card.dataset.emoji;
    flippedCards.push(card);

    if (flippedCards.length === 2) {
      const [first, second] = flippedCards;
      if (first.dataset.emoji === second.dataset.emoji) {
        first.classList.add('matched');
        second.classList.add('matched');
        flippedCards = [];
        matchedCount++;
        checkEndGame();
      } else {
        setTimeout(() => {
          first.classList.remove('flipped');
          second.classList.remove('flipped');
          first.innerText = "";
          second.innerText = "";
          flippedCards = [];
        }, 800);
      }
    }
  }

  function checkEndGame() {
    if (matchedCount === 12) {
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        if (!card.classList.contains('matched')) {
          card.classList.add('flipped', 'unique');
          card.innerText = card.dataset.emoji;
        }
      });
      setTimeout(() => {
        document.getElementById('phase2').style.display = "none";
        revealBox(2, "🎧");
        startMaze();
      }, 1000);
    }
  }

  // ===================== PHASE 3 (Maze) =====================
  const mazeLayout = [
    "#######",
    "#S....#",
    "###.#.#",
    "#.....#",
    "#.###.#",
    "#...G.#",
    "#######"
  ];
  let playerPos = {x:1, y:1};

  function startMaze() {
    document.getElementById("phase3").style.display = "block";
    drawMaze();
    enableSwipe();
  }

  function drawMaze() {
    const maze = document.getElementById("maze");
    maze.innerHTML = "";
    mazeLayout.forEach((row, y) => {
      row.split("").forEach((cell, x) => {
        const div = document.createElement("div");
        div.className = "maze-cell";
        if (cell === "#") div.classList.add("wall");
        if (x === playerPos.x && y === playerPos.y) {
          div.classList.add("player");
          div.innerText = "✏️";
        } else if (cell === "G") {
          div.classList.add("goal");
          div.innerText = "📓";
        }
        maze.appendChild(div);
      });
    });
  }

  function movePlayer(dx, dy) {
    const newX = playerPos.x + dx;
    const newY = playerPos.y + dy;
    if (mazeLayout[newY][newX] !== "#") {
      playerPos = {x:newX, y:newY};
      drawMaze();
      if (mazeLayout[newY][newX] === "G") {
        revealBox(3, "✏️📓");
      }
    }
  }

  // ==== Swipe detection ====
  function enableSwipe() {
    let startX, startY;
    const maze = document.getElementById("maze");

    maze.addEventListener("touchstart", e => {
      const touch = e.changedTouches[0];
      startX = touch.clientX;
      startY = touch.clientY;
    });

    maze.addEventListener("touchend", e => {
      const touch = e.changedTouches[0];
      const dx = touch.clientX - startX;
      const dy = touch.clientY - startY;
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 30) movePlayer(1,0);   // swipe right
        if (dx < -30) movePlayer(-1,0); // swipe left
      } else {
        if (dy > 30) movePlayer(0,1);   // swipe down
        if (dy < -30) movePlayer(0,-1); // swipe up
      }
    });
  }
</script>

</body>
</html>

